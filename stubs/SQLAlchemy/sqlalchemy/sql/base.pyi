from _typeshed import Incomplete
from abc import ABCMeta, abstractmethod
from collections.abc import Iterable, MutableMapping
from typing import Any, ClassVar, NoReturn
from typing_extensions import Self, TypeAlias

from .. import util
from ..engine.base import Connection, Engine
from ..engine.cursor import CursorResult
from ..sql.schema import Column
from ..util import HasMemoized, hybridmethod, memoized_property
from . import roles
from .elements import ColumnElement
from .traversals import (
    HasCacheKey as HasCacheKey,
    HasCopyInternals as HasCopyInternals,
    MemoizedHasCacheKey as MemoizedHasCacheKey,
)
from .visitors import ExternalTraversal

_Unused: TypeAlias = object

coercions: Any
elements: Any
type_api: Any
PARSE_AUTOCOMMIT: Any
NO_ARG: Any

class Immutable:
    def unique_params(self, *optionaldict, **kwargs) -> None: ...
    def params(self, *optionaldict, **kwargs) -> None: ...

class SingletonConstant(Immutable):
    def __new__(cls, *arg, **kw): ...

class _DialectArgView(MutableMapping[Any, Any]):
    obj: Any
    def __init__(self, obj) -> None: ...
    def __getitem__(self, key): ...
    def __setitem__(self, key, value) -> None: ...
    def __delitem__(self, key) -> None: ...
    def __len__(self) -> int: ...
    def __iter__(self): ...

class _DialectArgDict(MutableMapping[Any, Any]):
    def __init__(self) -> None: ...
    def __len__(self) -> int: ...
    def __iter__(self): ...
    def __getitem__(self, key): ...
    def __setitem__(self, key, value) -> None: ...
    def __delitem__(self, key) -> None: ...

class DialectKWArgs:
    @classmethod
    def argument_for(cls, dialect_name, argument_name, default) -> None: ...
    @memoized_property
    def dialect_kwargs(self) -> _DialectArgView: ...
    @property
    def kwargs(self) -> memoized_property[_DialectArgView]: ...
    @memoized_property
    def dialect_options(self) -> util.PopulateDict: ...

class CompileState:
    plugins: Any
    @classmethod
    def create_for_statement(cls, statement, compiler, **kw): ...
    statement: Any
    def __init__(self, statement, compiler, **kw) -> None: ...
    @classmethod
    def get_plugin_class(cls, statement): ...
    @classmethod
    def plugin_for(cls, plugin_name, visit_name): ...

class Generative(HasMemoized): ...
class InPlaceGenerative(HasMemoized): ...
class HasCompileState(Generative): ...

class _MetaOptions(type):
    def __init__(cls, classname, bases, dict_) -> None: ...
    def __add__(self, other): ...

class Options(metaclass=_MetaOptions):
    def __init__(self, **kw) -> None: ...
    def __add__(self, other): ...
    def __eq__(self, other) -> bool: ...
    @classmethod
    def isinstance(cls, klass): ...
    @hybridmethod
    def add_to_element(self, name, value): ...
    @classmethod
    def safe_merge(cls, other): ...
    @classmethod
    def from_execution_options(cls, key, attrs, exec_options, statement_exec_options): ...

class CacheableOptions(Options, HasCacheKey): ...

class ExecutableOption(HasCopyInternals):
    __visit_name__: str

class Executable(roles.StatementRole, Generative):
    supports_execution: bool
    is_select: bool
    is_update: bool
    is_insert: bool
    is_text: bool
    is_delete: bool
    is_dml: bool
    def options(self, *options) -> Self: ...
    def execution_options(self, **kw) -> Self: ...
    def get_execution_options(self) -> Self: ...
    def execute(self, *multiparams, **params) -> CursorResult: ...
    def scalar(self, *multiparams, **params): ...
    @property
    def bind(self) -> Engine | Connection | None: ...

class prefix_anon_map(dict[Any, Any]):
    def __missing__(self, key): ...

class SchemaEventTarget: ...

class SchemaVisitor(ExternalTraversal):
    __traverse_options__: Any

class ColumnCollection:
    def __init__(self, columns: Iterable[Column] | None = ...) -> None: ...
    def keys(self): ...
    def values(self): ...
    def items(self): ...
    def __bool__(self) -> bool: ...
    def __len__(self) -> int: ...
    def __iter__(self): ...
    def __getitem__(self, key: str): ...
    def __getattr__(self, key: str): ...
    def __contains__(self, key: str) -> bool: ...
    def compare(self, other): ...
    def __eq__(self, other) -> bool: ...
    def get(self, key, default: Incomplete | None = ...): ...
    @abstractmethod
    def __setitem__(self, key: str, value: Column) -> None: ...
    @abstractmethod
    def __delitem__(self, key: str) -> None: ...
    @abstractmethod
    def __setattr__(self, key: str, obj: Column) -> None: ...
    @abstractmethod
    def clear(self) -> None: ...
    @abstractmethod
    def remove(self, column: Column) -> None: ...
    @abstractmethod
    def update(self, iter_: Iterable[Column]) -> None: ...
    __hash__: ClassVar[None]  # type: ignore[assignment]
    def add(self, column: Column, key: Incomplete | None = ...) -> None: ...
    def contains_column(self, col: Column) -> bool: ...
    def as_immutable(self) -> ImmutableColumnCollection: ...
    def corresponding_column(self, column: Column, require_embedded: bool = ...): ...

class DedupeColumnCollection(ColumnCollection, metaclass=ABCMeta):
    def add(self, column: Column, key: Incomplete | None = ...) -> None: ...
    def extend(self, iter_: Iterable[Column]) -> None: ...
    def remove(self, column: Column) -> None: ...
    def replace(self, column: Column) -> None: ...

class ImmutableColumnCollection(util.ImmutableContainer, ColumnCollection, metaclass=ABCMeta):
    def __init__(self, collection: ColumnCollection) -> None: ...
    def add(self, *arg: _Unused, **kw: _Unused) -> NoReturn: ...
    def extend(self, *arg: _Unused, **kw: _Unused) -> NoReturn: ...
    def remove(self, *arg: _Unused, **kw: _Unused) -> NoReturn: ...
    def __getstate__(self) -> dict[str, ColumnCollection]: ...
    def __setstate__(self, state: dict[str, ColumnCollection]) -> None: ...

class ColumnSet(util.ordered_column_set[ColumnElement[Any]]):
    def contains_column(self, col): ...
    def extend(self, cols) -> None: ...
    def __add__(self, other): ...
    def __eq__(self, other) -> bool: ...
    def __hash__(self) -> int: ...  # type: ignore[override]
